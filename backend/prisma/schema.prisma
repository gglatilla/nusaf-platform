// Prisma Schema for Nusaf Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(CUSTOMER)
  isActive  Boolean  @default(true) @map("is_active")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Primary warehouse for stock display (user sees their warehouse stock as hero metric)
  primaryWarehouse Warehouse? @map("primary_warehouse")

  sessions Session[]

  // Issue Flag relations
  createdIssues  IssueFlag[]    @relation("CreatedIssues")
  resolvedIssues IssueFlag[]    @relation("ResolvedIssues")
  issueComments  IssueComment[]

  // Document relations
  uploadedDocuments Document[]

  // Auth metadata
  lastLoginAt    DateTime? @map("last_login_at")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("users")
}

model Session {
  id           String  @id @default(cuid())
  token        String  @unique
  refreshToken String? @unique @map("refresh_token")
  userId       String  @map("user_id")
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Expiry
  expiresAt        DateTime  @map("expires_at")
  refreshExpiresAt DateTime? @map("refresh_expires_at")

  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Audit
  createdAt  DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Company {
  id                 String       @id @default(cuid())
  name               String
  tradingName        String?      @map("trading_name")
  registrationNumber String?      @map("registration_number")
  vatNumber          String?      @map("vat_number")
  tier               CustomerTier @default(END_USER)
  isActive           Boolean      @default(true) @map("is_active")

  // Primary warehouse for fulfillment (CT customers check CT stock first, spill to JHB)
  primaryWarehouse Warehouse? @map("primary_warehouse")

  users      User[]
  addresses  CompanyAddress[]
  contacts   CompanyContact[]
  quotes     Quote[]
  orders     SalesOrder[]
  issueFlags IssueFlag[]
  documents  Document[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("companies")
}

model CompanyAddress {
  id         String      @id @default(cuid())
  companyId  String      @map("company_id")
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  type       AddressType
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String      @map("postal_code")
  country    String      @default("South Africa")
  isDefault  Boolean     @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("company_addresses")
}

model CompanyContact {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("company_contacts")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  SALES
  PURCHASER
  WAREHOUSE
  CUSTOMER
}

enum CustomerTier {
  END_USER
  OEM_RESELLER
  DISTRIBUTOR
}

enum AddressType {
  BILLING
  SHIPPING
}

enum SupplierCurrency {
  EUR
  ZAR
}

enum SkuHandling {
  DIRECT
  TECOM_CONVERSION
  NUSAF_INTERNAL
}

enum UnitOfMeasure {
  EA
  MTR
  KG
  SET
  PR
  ROL
  BX
}

enum ProductType {
  STOCK_ONLY
  ASSEMBLY_REQUIRED
  MADE_TO_ORDER
  KIT
}

// ============================================
// PRODUCT CATALOG ENTITIES
// ============================================

model Supplier {
  id          String           @id @default(cuid())
  code        String           @unique // TECOM, CHIARAVALLI, REGINA, NUSAF
  name        String
  country     String           @default("Italy")
  currency    SupplierCurrency @default(EUR)
  skuHandling SkuHandling      @map("sku_handling")
  isLocal     Boolean          @default(false) @map("is_local")
  isActive    Boolean          @default(true) @map("is_active")

  // Contact info
  email   String?
  phone   String?
  website String?

  // Address
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  postalCode   String? @map("postal_code")

  // Business terms
  paymentTerms      String?  @map("payment_terms")
  minimumOrderValue Decimal? @map("minimum_order_value") @db.Decimal(12, 2)
  notes             String?

  // Relations
  products       Product[]
  skuMappings    SkuMapping[]
  pricingRules   PricingRule[]
  contacts       SupplierContact[]
  purchaseOrders PurchaseOrder[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("suppliers")
}

model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String
  phone     String?
  role      String?
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([supplierId])
  @@map("supplier_contacts")
}

model Category {
  id          String  @id @default(cuid())
  code        String  @unique // e.g., CONV, LVL, BRG
  name        String // e.g., "Conveyor Components"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  subCategories SubCategory[]
  products      Product[]
  pricingRules  PricingRule[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("categories")
}

model SubCategory {
  id          String  @id @default(cuid())
  code        String // e.g., BASES, UCF
  name        String // e.g., "Bases", "UCF Bearings"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Parent category
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  // Relations
  products     Product[]
  pricingRules PricingRule[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([categoryId, code])
  @@index([categoryId])
  @@map("sub_categories")
}

model Product {
  id            String        @id @default(cuid())
  supplierSku   String        @map("supplier_sku")
  nusafSku      String        @unique @map("nusaf_sku")
  description   String
  unitOfMeasure UnitOfMeasure @default(EA) @map("unit_of_measure")
  isActive      Boolean       @default(true) @map("is_active")

  // Pricing
  costPrice      Decimal?  @map("cost_price") @db.Decimal(10, 4)
  listPrice      Decimal?  @map("list_price") @db.Decimal(10, 2)
  priceUpdatedAt DateTime? @map("price_updated_at")

  // Inventory defaults (product-level, can be overridden per location on StockLevel)
  defaultReorderPoint Int? @map("default_reorder_point") // When to trigger reorder
  defaultReorderQty   Int? @map("default_reorder_qty")   // How many to order
  defaultMinStock     Int? @map("default_min_stock")     // Safety stock level
  defaultMaxStock     Int? @map("default_max_stock")     // Max storage capacity
  leadTimeDays        Int? @map("lead_time_days")        // Supplier lead time

  // Product classification (for orchestration)
  productType      ProductType @default(STOCK_ONLY) @map("product_type")
  assemblyLeadDays Int?        @map("assembly_lead_days") // Days to assemble/manufacture
  isConfigurable   Boolean     @default(false) @map("is_configurable")

  // Extended product info
  longDescription String?  @map("long_description")
  weight          Decimal? @db.Decimal(10, 3) // Weight in kg
  dimensionsJson  Json?    @map("dimensions_json") // { length, width, height, unit }
  imageUrl        String?  @map("image_url")

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Categorization
  categoryId    String       @map("category_id")
  category      Category     @relation(fields: [categoryId], references: [id])
  subCategoryId String?      @map("sub_category_id")
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  // Relations
  crossReferences   CompetitorCrossReference[]
  stockLevels       StockLevel[]
  stockMovements    StockMovement[]
  stockReservations StockReservation[]

  // BOM Relations
  bomComponents  BomItem[] @relation("ParentProduct")    // Components needed to build this product
  usedInProducts BomItem[] @relation("ComponentProduct") // Products that use this as a component

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([nusafSku])
  @@index([isActive, deletedAt]) // Performance: filter active products
  @@map("products")
}

model CompetitorCrossReference {
  id              String  @id @default(cuid())
  competitorBrand String  @map("competitor_brand") // e.g., "Rexnord", "Intralox"
  competitorSku   String  @map("competitor_sku")
  notes           String? // Fit notes, compatibility details

  // Verification for SEO quality
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  // Link to Nusaf product
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([competitorBrand, competitorSku])
  @@index([productId])
  @@index([competitorSku])
  @@map("competitor_cross_references")
}

model SkuMapping {
  id          String  @id @default(cuid())
  supplierSku String  @map("supplier_sku")
  nusafSku    String  @map("nusaf_sku")
  isOverride  Boolean @default(false) @map("is_override") // true = manual override, false = auto-generated
  notes       String? // Reason for override

  // Supplier (primarily for Tecom)
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Optional category reassignment (e.g., Idler Wheels moved to Sprockets and Idlers)
  overrideCategoryId String? @map("override_category_id")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierSku])
  @@index([nusafSku])
  @@map("sku_mappings")
}

// ============================================
// IMPORT TRACKING ENTITIES
// ============================================

model ImportBatch {
  id            String       @id @default(cuid())
  fileName      String       @map("file_name")
  supplierCode  String       @map("supplier_code")
  status        ImportStatus @default(PENDING)
  totalRows     Int          @default(0) @map("total_rows")
  processedRows Int          @default(0) @map("processed_rows")
  successRows   Int          @default(0) @map("success_rows")
  errorRows     Int          @default(0) @map("error_rows")

  // Column mapping used for import (stored as JSON)
  columnMapping Json? @map("column_mapping")

  // File errors (not row-level errors)
  fileErrors Json? @map("file_errors")

  // Relations
  rows ImportRow[]

  // Audit
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by")
  completedAt DateTime? @map("completed_at")

  @@index([supplierCode])
  @@index([status])
  @@index([createdAt])
  @@map("import_batches")
}

model ImportRow {
  id              String          @id @default(cuid())
  rowNumber       Int             @map("row_number")
  supplierSku     String          @map("supplier_sku")
  nusafSku        String?         @map("nusaf_sku")
  description     String?
  price           Decimal?        @db.Decimal(10, 4)
  unitOfMeasure   String?         @map("unit_of_measure")
  categoryCode    String?         @map("category_code")
  subcategoryCode String?         @map("subcategory_code")
  status          ImportRowStatus @default(PENDING)

  // Validation results (stored as JSON arrays)
  errors   Json? // Array of { field: string, message: string }
  warnings Json? // Array of { field: string, message: string }

  // Link to created/updated product (set after successful import)
  productId String? @map("product_id")

  // Parent batch
  batchId String      @map("batch_id")
  batch   ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  @@index([batchId])
  @@index([status])
  @@map("import_rows")
}

enum ImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  IMPORTING
  COMPLETED
  FAILED
}

enum ImportRowStatus {
  PENDING
  SUCCESS
  ERROR
  SKIPPED
}

enum QuoteStatus {
  DRAFT
  CREATED
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  CONVERTED
}

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  PROCESSING
  READY_TO_SHIP
  PARTIALLY_SHIPPED
  SHIPPED
  DELIVERED
  INVOICED
  CLOSED
  ON_HOLD
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  SENT
  ACKNOWLEDGED
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

enum FulfillmentType {
  STOCK_ONLY
  ASSEMBLY_REQUIRED
  MIXED
}

enum Warehouse {
  JHB
  CT
}

enum SalesOrderLineStatus {
  PENDING
  PICKING
  PICKED
  SHIPPED
  DELIVERED
}

enum PickingSlipStatus {
  PENDING
  IN_PROGRESS
  COMPLETE
}

// Inventory Management Enums
enum StockMovementType {
  RECEIPT           // Goods received from supplier
  ISSUE             // Goods picked for sales order
  TRANSFER_OUT      // Sent to another location
  TRANSFER_IN       // Received from another location
  MANUFACTURE_IN    // Finished goods from production
  MANUFACTURE_OUT   // Raw materials consumed
  ADJUSTMENT_IN     // Manual correction (positive)
  ADJUSTMENT_OUT    // Manual correction (negative)
  SCRAP             // Damaged/scrapped goods
}

enum StockAdjustmentReason {
  INITIAL_COUNT
  CYCLE_COUNT
  DAMAGED
  EXPIRED
  FOUND
  LOST
  DATA_CORRECTION
  OTHER
}

enum StockAdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReservationType {
  SOFT  // For quotes - doesn't reduce available
  HARD  // For confirmed orders - reduces available
}

// ============================================
// PRICING ENTITIES
// ============================================

model GlobalSettings {
  id            String   @id @default("global")
  eurZarRate    Decimal  @map("eur_zar_rate") @db.Decimal(10, 4)
  rateUpdatedAt DateTime @map("rate_updated_at")
  rateUpdatedBy String?  @map("rate_updated_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("global_settings")
}

model PricingRule {
  id            String       @id @default(cuid())
  supplierId    String       @map("supplier_id")
  supplier      Supplier     @relation(fields: [supplierId], references: [id])
  categoryId    String       @map("category_id")
  category      Category     @relation(fields: [categoryId], references: [id])
  subCategoryId String?      @map("sub_category_id")
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  // Pricing parameters
  isGross         Boolean  @default(false) @map("is_gross")
  discountPercent Decimal? @map("discount_percent") @db.Decimal(5, 2)
  freightPercent  Decimal  @map("freight_percent") @db.Decimal(5, 2)
  marginDivisor   Decimal  @map("margin_divisor") @db.Decimal(5, 4)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([supplierId, categoryId, subCategoryId])
  @@index([supplierId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@map("pricing_rules")
}

// ============================================
// QUOTE ENTITIES
// ============================================

model Quote {
  id           String       @id @default(cuid())
  quoteNumber  String       @unique @map("quote_number") // QUO-2025-00001
  companyId    String       @map("company_id")
  company      Company      @relation(fields: [companyId], references: [id])
  userId       String       @map("user_id") // User who created the quote
  status       QuoteStatus  @default(DRAFT)
  customerTier CustomerTier @map("customer_tier") // Snapshot at time of quote

  // Validity
  validUntil DateTime? @map("valid_until") // Set on finalization (30 days)

  // Totals (ZAR)
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  vatRate   Decimal @default(15) @map("vat_rate") @db.Decimal(5, 2)
  vatAmount Decimal @default(0) @map("vat_amount") @db.Decimal(12, 2)
  total     Decimal @default(0) @db.Decimal(12, 2)

  // Notes
  customerNotes String? @map("customer_notes")

  // Document
  pdfUrl String? @map("pdf_url")

  // Relations
  items QuoteItem[]

  // Timestamps
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  finalizedAt    DateTime? @map("finalized_at")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([quoteNumber])
  @@index([lastActivityAt])
  @@index([userId, status, deletedAt]) // Performance: draft quote lookup
  @@map("quotes")
}

model QuoteItem {
  id         String @id @default(cuid())
  quoteId    String @map("quote_id")
  quote      Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  lineNumber Int    @map("line_number")

  // Product reference and snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku") // Snapshot of nusafSku
  productDescription String @map("product_description") // Snapshot of description

  // Quantity and pricing
  quantity  Int // Whole units only
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2) // Tier price at time of add
  lineTotal Decimal @map("line_total") @db.Decimal(12, 2) // quantity * unitPrice

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([quoteId])
  @@index([productId])
  @@index([quoteId, productId]) // Performance: duplicate item check
  @@map("quote_items")
}

model QuoteRequest {
  id          String  @id @default(cuid())
  sessionId   String  @map("session_id") // Browser session ID for guest tracking
  email       String
  companyName String  @map("company_name")
  phone       String?
  notes       String?

  // Cart data (stored as JSON before conversion to Quote)
  cartData Json @map("cart_data")

  // Status
  isConverted Boolean   @default(false) @map("is_converted")
  convertedAt DateTime? @map("converted_at")
  convertedTo String?   @map("converted_to") // Quote ID if converted

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([email])
  @@index([isConverted])
  @@map("quote_requests")
}

model QuoteCounter {
  id    String @id @default("quote_counter")
  year  Int
  count Int    @default(0)

  @@map("quote_counter")
}

// ============================================
// SALES ORDER ENTITIES
// ============================================

model SalesOrder {
  id          String           @id @default(cuid())
  orderNumber String           @unique @map("order_number") // SO-2025-00001
  companyId   String           @map("company_id")
  company     Company          @relation(fields: [companyId], references: [id])
  userId      String           @map("user_id") // User who created the order
  status      SalesOrderStatus @default(DRAFT)

  // Source quote (optional - orders can be created from quotes or directly)
  quoteId     String? @map("quote_id")
  quoteNumber String? @map("quote_number") // Snapshot for reference

  // Customer PO reference
  customerPoNumber String?   @map("customer_po_number")
  customerPoDate   DateTime? @map("customer_po_date")

  // Fulfillment
  fulfillmentType FulfillmentType @default(STOCK_ONLY) @map("fulfillment_type")
  warehouse       Warehouse       @default(JHB)

  // Dates
  requiredDate  DateTime? @map("required_date")
  promisedDate  DateTime? @map("promised_date")
  shippedDate   DateTime? @map("shipped_date")
  deliveredDate DateTime? @map("delivered_date")

  // Totals (ZAR)
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  vatRate   Decimal @default(15) @map("vat_rate") @db.Decimal(5, 2)
  vatAmount Decimal @default(0) @map("vat_amount") @db.Decimal(12, 2)
  total     Decimal @default(0) @db.Decimal(12, 2)

  // Notes
  internalNotes String? @map("internal_notes")
  customerNotes String? @map("customer_notes")
  holdReason    String? @map("hold_reason")
  cancelReason  String? @map("cancel_reason")

  // Relations
  lines     SalesOrderLine[]
  documents Document[]

  // Audit
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String?   @map("created_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   String?   @map("updated_by")
  confirmedAt DateTime? @map("confirmed_at")
  confirmedBy String?   @map("confirmed_by")
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by")

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([quoteId])
  @@map("sales_orders")
}

model SalesOrderLine {
  id         String               @id @default(cuid())
  orderId    String               @map("order_id")
  order      SalesOrder           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  lineNumber Int                  @map("line_number")
  status     SalesOrderLineStatus @default(PENDING)

  // Product reference and snapshot (preserved from quote/at time of order)
  productId          String @map("product_id")
  productSku         String @map("product_sku") // Snapshot of nusafSku
  productDescription String @map("product_description") // Snapshot of description

  // Quantities
  quantityOrdered Int @map("quantity_ordered")
  quantityPicked  Int @default(0) @map("quantity_picked")
  quantityShipped Int @default(0) @map("quantity_shipped")

  // Pricing (ZAR, copied from quote)
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2)
  lineTotal Decimal @map("line_total") @db.Decimal(12, 2)

  // Notes
  notes String?

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([productId])
  @@map("sales_order_lines")
}

model SalesOrderCounter {
  id    String @id @default("order_counter")
  year  Int
  count Int    @default(0)

  @@map("sales_order_counter")
}

// ============================================
// PICKING SLIP ENTITIES
// ============================================

model PickingSlip {
  id                String            @id @default(cuid())
  pickingSlipNumber String            @unique @map("picking_slip_number") // PS-2026-00001
  companyId         String            @map("company_id")
  orderId           String            @map("order_id")
  orderNumber       String            @map("order_number") // Snapshot
  location          Warehouse // JHB or CT
  status            PickingSlipStatus @default(PENDING)

  // Assignment
  assignedTo     String? @map("assigned_to") // User ID
  assignedToName String? @map("assigned_to_name") // Snapshot

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  lines      PickingSlipLine[]
  issueFlags IssueFlag[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([orderId])
  @@index([location, status])
  @@map("picking_slips")
}

model PickingSlipLine {
  id            String      @id @default(cuid())
  pickingSlipId String      @map("picking_slip_id")
  pickingSlip   PickingSlip @relation(fields: [pickingSlipId], references: [id], onDelete: Cascade)
  orderLineId   String      @map("order_line_id")
  lineNumber    Int         @map("line_number")

  // Product snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku")
  productDescription String @map("product_description")

  // Quantities
  quantityToPick Int @map("quantity_to_pick")
  quantityPicked Int @default(0) @map("quantity_picked")

  // Picking info
  pickedAt    DateTime? @map("picked_at")
  pickedBy    String?   @map("picked_by")
  binLocation String?   @map("bin_location") // Optional warehouse location

  @@index([pickingSlipId])
  @@map("picking_slip_lines")
}

model PickingSlipCounter {
  id    String @id @default("picking_slip_counter")
  year  Int
  count Int    @default(0)

  @@map("picking_slip_counter")
}

// ============================================
// JOB CARD ENTITIES
// ============================================

enum JobCardStatus {
  PENDING
  IN_PROGRESS
  ON_HOLD
  COMPLETE
}

enum JobType {
  MACHINING
  ASSEMBLY
}

model JobCard {
  id            String @id @default(cuid())
  jobCardNumber String @unique @map("job_card_number") // JC-2026-00001
  companyId     String @map("company_id")
  orderId       String @map("order_id")
  orderNumber   String @map("order_number") // Snapshot
  orderLineId   String @map("order_line_id")

  // Product snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku")
  productDescription String @map("product_description")
  quantity           Int

  // Job details
  jobType    JobType       @map("job_type")
  status     JobCardStatus @default(PENDING)
  holdReason String?       @map("hold_reason") // Required if ON_HOLD
  notes      String?

  // Assignment
  assignedTo     String? @map("assigned_to")
  assignedToName String? @map("assigned_to_name")

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  issueFlags IssueFlag[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([orderId])
  @@index([status])
  @@map("job_cards")
}

model JobCardCounter {
  id    String @id @default("job_card_counter")
  year  Int
  count Int    @default(0)

  @@map("job_card_counter")
}

// ============================================
// TRANSFER REQUEST ENTITIES
// ============================================

enum TransferRequestStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
}

model TransferRequest {
  id             String @id @default(cuid())
  transferNumber String @unique @map("transfer_number") // TR-2026-00001
  companyId      String @map("company_id")

  // Order reference (optional - transfers can be standalone for stock replenishment)
  orderId     String? @map("order_id")
  orderNumber String? @map("order_number") // Snapshot

  // Locations (always JHB â†’ CT)
  fromLocation Warehouse @default(JHB) @map("from_location")
  toLocation   Warehouse @default(CT) @map("to_location")

  // Status
  status TransferRequestStatus @default(PENDING)
  notes  String?

  // Shipping info
  shippedAt     DateTime? @map("shipped_at")
  shippedBy     String?   @map("shipped_by")
  shippedByName String?   @map("shipped_by_name")

  // Receiving info
  receivedAt     DateTime? @map("received_at")
  receivedBy     String?   @map("received_by")
  receivedByName String?   @map("received_by_name")

  // Relations
  lines TransferRequestLine[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([orderId])
  @@index([status])
  @@map("transfer_requests")
}

model TransferRequestLine {
  id                String          @id @default(cuid())
  transferRequestId String          @map("transfer_request_id")
  transferRequest   TransferRequest @relation(fields: [transferRequestId], references: [id], onDelete: Cascade)
  lineNumber        Int             @map("line_number")

  // Product snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku")
  productDescription String @map("product_description")

  // Quantities
  quantity         Int // Quantity to transfer
  receivedQuantity Int @default(0) @map("received_quantity")

  // Optional link to order line
  orderLineId String? @map("order_line_id")

  @@index([transferRequestId])
  @@map("transfer_request_lines")
}

model TransferRequestCounter {
  id    String @id @default("transfer_request_counter")
  year  Int
  count Int    @default(0)

  @@map("transfer_request_counter")
}

// ============================================
// ISSUE FLAG ENTITIES
// ============================================

enum IssueFlagCategory {
  STOCK
  QUALITY
  PRODUCTION
  TIMING
  DOCUMENTATION
}

enum IssueFlagSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueFlagStatus {
  OPEN
  IN_PROGRESS
  PENDING_INFO
  RESOLVED
  CLOSED
}

model IssueFlag {
  id          String  @id @default(cuid())
  issueNumber String  @unique @map("issue_number") // ISS-2026-00001
  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  // Polymorphic: one of these will be set
  pickingSlipId String?      @map("picking_slip_id")
  pickingSlip   PickingSlip? @relation(fields: [pickingSlipId], references: [id])
  jobCardId     String?      @map("job_card_id")
  jobCard       JobCard?     @relation(fields: [jobCardId], references: [id])

  category    IssueFlagCategory
  severity    IssueFlagSeverity
  status      IssueFlagStatus   @default(OPEN)
  title       String
  description String

  // SLA tracking
  slaDeadline DateTime  @map("sla_deadline")
  escalatedAt DateTime? @map("escalated_at")

  // Resolution
  resolution   String?
  resolvedAt   DateTime? @map("resolved_at")
  resolvedById String?   @map("resolved_by_id")
  resolvedBy   User?     @relation("ResolvedIssues", fields: [resolvedById], references: [id])

  // Audit
  createdById String   @map("created_by_id")
  createdBy   User     @relation("CreatedIssues", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  comments IssueComment[]

  @@index([companyId])
  @@index([pickingSlipId])
  @@index([jobCardId])
  @@index([status])
  @@index([severity])
  @@index([slaDeadline])
  @@map("issue_flags")
}

model IssueComment {
  id          String    @id @default(cuid())
  issueFlagId String    @map("issue_flag_id")
  issueFlag   IssueFlag @relation(fields: [issueFlagId], references: [id], onDelete: Cascade)
  content     String
  createdById String    @map("created_by_id")
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([issueFlagId])
  @@map("issue_comments")
}

model IssueFlagCounter {
  id    String @id @default("issue_flag_counter")
  year  Int
  count Int    @default(0)

  @@map("issue_flag_counter")
}

// ============================================
// INVENTORY MANAGEMENT ENTITIES
// ============================================

model StockLevel {
  id              String    @id @default(cuid())
  productId       String    @map("product_id")
  product         Product   @relation(fields: [productId], references: [id])
  location        Warehouse

  onHand          Int       @default(0) @map("on_hand")
  softReserved    Int       @default(0) @map("soft_reserved")
  hardReserved    Int       @default(0) @map("hard_reserved")
  onOrder         Int       @default(0) @map("on_order")

  // Reorder settings (location-specific overrides, null = use product defaults)
  reorderPoint    Int?      @map("reorder_point")    // When to trigger reorder
  reorderQuantity Int?      @map("reorder_quantity") // How many to order
  minimumStock    Int?      @map("minimum_stock")    // Safety stock level
  maximumStock    Int?      @map("maximum_stock")    // Max storage capacity

  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String?   @map("created_by")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  updatedBy       String?   @map("updated_by")

  @@unique([productId, location])
  @@index([productId])
  @@index([location])
  @@map("stock_levels")
}

model StockMovement {
  id               String              @id @default(cuid())
  productId        String              @map("product_id")
  product          Product             @relation(fields: [productId], references: [id])
  location         Warehouse
  movementType     StockMovementType   @map("movement_type")
  quantity         Int
  balanceAfter     Int                 @map("balance_after")

  referenceType    String?             @map("reference_type")
  referenceId      String?             @map("reference_id")
  referenceNumber  String?             @map("reference_number")

  adjustmentReason StockAdjustmentReason? @map("adjustment_reason")
  notes            String?

  createdAt        DateTime            @default(now()) @map("created_at")
  createdBy        String              @map("created_by")

  @@index([productId, location])
  @@index([movementType])
  @@index([createdAt])
  @@map("stock_movements")
}

model StockAdjustment {
  id               String                @id @default(cuid())
  adjustmentNumber String                @unique @map("adjustment_number")
  location         Warehouse
  reason           StockAdjustmentReason
  notes            String?
  status           StockAdjustmentStatus @default(PENDING)

  approvedAt       DateTime?             @map("approved_at")
  approvedBy       String?               @map("approved_by")
  rejectedAt       DateTime?             @map("rejected_at")
  rejectedBy       String?               @map("rejected_by")
  rejectionReason  String?               @map("rejection_reason")

  lines            StockAdjustmentLine[]

  createdAt        DateTime              @default(now()) @map("created_at")
  createdBy        String                @map("created_by")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  updatedBy        String?               @map("updated_by")

  @@index([status])
  @@index([location])
  @@map("stock_adjustments")
}

model StockAdjustmentLine {
  id                 String          @id @default(cuid())
  adjustmentId       String          @map("adjustment_id")
  adjustment         StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  lineNumber         Int             @map("line_number")

  productId          String          @map("product_id")
  productSku         String          @map("product_sku")
  productDescription String          @map("product_description")

  currentQuantity    Int             @map("current_quantity")
  adjustedQuantity   Int             @map("adjusted_quantity")
  difference         Int
  notes              String?

  @@index([adjustmentId])
  @@map("stock_adjustment_lines")
}

model StockAdjustmentCounter {
  id    String @id @default("stock_adjustment_counter")
  year  Int
  count Int    @default(0)

  @@map("stock_adjustment_counter")
}

model StockReservation {
  id              String          @id @default(cuid())
  productId       String          @map("product_id")
  product         Product         @relation(fields: [productId], references: [id])
  location        Warehouse
  reservationType ReservationType @map("reservation_type")
  quantity        Int

  // Reference to quote or order
  referenceType   String          @map("reference_type")  // Quote, SalesOrder
  referenceId     String          @map("reference_id")
  referenceNumber String?         @map("reference_number")

  // For soft reservations - expires with quote validity
  expiresAt       DateTime?       @map("expires_at")

  // Release tracking
  releasedAt      DateTime?       @map("released_at")
  releasedBy      String?         @map("released_by")
  releaseReason   String?         @map("release_reason")

  createdAt       DateTime        @default(now()) @map("created_at")
  createdBy       String          @map("created_by")

  @@index([productId, location])
  @@index([referenceType, referenceId])
  @@index([reservationType])
  @@index([expiresAt])
  @@map("stock_reservations")
}

// ============================================
// DOCUMENT ARCHIVE ENTITIES
// ============================================

enum DocumentType {
  CUSTOMER_PO
  SIGNED_DELIVERY_NOTE
}

model Document {
  id        String     @id @default(cuid())
  companyId String     @map("company_id")
  company   Company    @relation(fields: [companyId], references: [id])
  orderId   String     @map("order_id")
  order     SalesOrder @relation(fields: [orderId], references: [id])

  type      DocumentType
  filename  String
  mimeType  String       @map("mime_type")
  sizeBytes Int          @map("size_bytes")
  r2Key     String       @unique @map("r2_key")

  uploadedById String   @map("uploaded_by_id")
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  // Retention (7 years per Tax Act)
  retainUntil DateTime @map("retain_until")

  @@index([companyId])
  @@index([orderId])
  @@index([type])
  @@map("documents")
}

// ============================================
// BILL OF MATERIALS ENTITIES
// ============================================

model BomItem {
  id                 String   @id @default(cuid())
  parentProductId    String   @map("parent_product_id")
  parentProduct      Product  @relation("ParentProduct", fields: [parentProductId], references: [id])
  componentProductId String   @map("component_product_id")
  componentProduct   Product  @relation("ComponentProduct", fields: [componentProductId], references: [id])

  quantity     Decimal  @db.Decimal(10, 4)
  unitOverride String?  @map("unit_override")
  notes        String?
  sortOrder    Int      @default(0) @map("sort_order")
  isOptional   Boolean  @default(false) @map("is_optional")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([parentProductId, componentProductId])
  @@index([parentProductId])
  @@index([componentProductId])
  @@map("bom_items")
}

// ============================================
// PURCHASE ORDER ENTITIES
// ============================================

model PurchaseOrder {
  id               String              @id @default(cuid())
  poNumber         String              @unique @map("po_number") // PO-2025-00001
  supplierId       String              @map("supplier_id")
  supplier         Supplier            @relation(fields: [supplierId], references: [id])
  status           PurchaseOrderStatus @default(DRAFT)
  deliveryLocation Warehouse           @default(JHB) @map("delivery_location")
  expectedDate     DateTime?           @map("expected_date")
  currency         SupplierCurrency    @default(EUR)

  // Totals (in supplier currency)
  subtotal Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @default(0) @db.Decimal(12, 2)

  // Source reference (optional - PO can be linked to a sales order)
  sourceOrderId String? @map("source_order_id")

  // Notes
  internalNotes String? @map("internal_notes")
  supplierNotes String? @map("supplier_notes")

  // Approval workflow (for PURCHASER role)
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?   @map("approved_by")
  rejectedAt      DateTime? @map("rejected_at")
  rejectedBy      String?   @map("rejected_by")
  rejectionReason String?   @map("rejection_reason")

  // Send tracking
  sentAt DateTime? @map("sent_at")
  sentBy String?   @map("sent_by")

  // Relations
  lines    PurchaseOrderLine[]
  receipts GoodsReceivedVoucher[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@index([supplierId])
  @@index([status])
  @@index([poNumber])
  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id              String        @id @default(cuid())
  purchaseOrderId String        @map("purchase_order_id")
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  lineNumber      Int           @map("line_number")

  // Product snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku")
  productDescription String @map("product_description")

  // Quantities
  quantityOrdered  Int @map("quantity_ordered")
  quantityReceived Int @default(0) @map("quantity_received")

  // Pricing (in supplier currency)
  unitCost  Decimal @map("unit_cost") @db.Decimal(10, 4)
  lineTotal Decimal @map("line_total") @db.Decimal(12, 2)

  // Optional link to sales order line (for procurement triggered by order)
  salesOrderLineId String? @map("sales_order_line_id")

  @@index([purchaseOrderId])
  @@map("purchase_order_lines")
}

model PurchaseOrderCounter {
  id    String @id @default("po_counter")
  year  Int
  count Int    @default(0)

  @@map("purchase_order_counter")
}

// ============================================
// GOODS RECEIVED VOUCHER ENTITIES
// ============================================

model GoodsReceivedVoucher {
  id              String        @id @default(cuid())
  grvNumber       String        @unique @map("grv_number") // GRV-2026-00001
  purchaseOrderId String        @map("purchase_order_id")
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  location       Warehouse // Delivery location (usually matches PO.deliveryLocation)
  receivedAt     DateTime  @default(now()) @map("received_at")
  receivedBy     String    @map("received_by")
  receivedByName String    @map("received_by_name")

  notes String?

  lines GrvLine[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([purchaseOrderId])
  @@index([location])
  @@index([receivedAt])
  @@map("goods_received_vouchers")
}

model GrvLine {
  id         String               @id @default(cuid())
  grvId      String               @map("grv_id")
  grv        GoodsReceivedVoucher @relation(fields: [grvId], references: [id], onDelete: Cascade)
  lineNumber Int                  @map("line_number")

  poLineId   String @map("po_line_id")
  productId  String @map("product_id")
  productSku String @map("product_sku")

  quantityExpected Int     @map("quantity_expected") // Remaining qty at time of receipt
  quantityReceived Int     @map("quantity_received")
  quantityRejected Int     @default(0) @map("quantity_rejected")
  rejectionReason  String? @map("rejection_reason")

  @@index([grvId])
  @@index([poLineId])
  @@map("grv_lines")
}

model GrvCounter {
  id    String @id @default("grv_counter")
  year  Int
  count Int    @default(0)

  @@map("grv_counter")
}
