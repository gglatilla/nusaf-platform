// Prisma Schema for Nusaf Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(CUSTOMER)
  isActive  Boolean  @default(true) @map("is_active")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  sessions Session[]

  // Auth metadata
  lastLoginAt    DateTime? @map("last_login_at")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("users")
}

model Session {
  id           String  @id @default(cuid())
  token        String  @unique
  refreshToken String? @unique @map("refresh_token")
  userId       String  @map("user_id")
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Expiry
  expiresAt        DateTime  @map("expires_at")
  refreshExpiresAt DateTime? @map("refresh_expires_at")

  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Audit
  createdAt  DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Company {
  id                 String       @id @default(cuid())
  name               String
  tradingName        String?      @map("trading_name")
  registrationNumber String?      @map("registration_number")
  vatNumber          String?      @map("vat_number")
  tier               CustomerTier @default(END_USER)
  isActive           Boolean      @default(true) @map("is_active")

  users     User[]
  addresses CompanyAddress[]
  contacts  CompanyContact[]
  quotes    Quote[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("companies")
}

model CompanyAddress {
  id         String      @id @default(cuid())
  companyId  String      @map("company_id")
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  type       AddressType
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String      @map("postal_code")
  country    String      @default("South Africa")
  isDefault  Boolean     @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("company_addresses")
}

model CompanyContact {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("company_contacts")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  SALES
  CUSTOMER
}

enum CustomerTier {
  END_USER
  OEM_RESELLER
  DISTRIBUTOR
}

enum AddressType {
  BILLING
  SHIPPING
}

enum SupplierCurrency {
  EUR
  ZAR
}

enum SkuHandling {
  DIRECT
  TECOM_CONVERSION
  NUSAF_INTERNAL
}

enum UnitOfMeasure {
  EA
  MTR
  KG
  SET
  PR
  ROL
  BX
}

// ============================================
// PRODUCT CATALOG ENTITIES
// ============================================

model Supplier {
  id          String           @id @default(cuid())
  code        String           @unique // TECOM, CHIARAVALLI, REGINA, NUSAF
  name        String
  country     String           @default("Italy")
  currency    SupplierCurrency @default(EUR)
  skuHandling SkuHandling      @map("sku_handling")
  isLocal     Boolean          @default(false) @map("is_local")
  isActive    Boolean          @default(true) @map("is_active")

  // Relations
  products     Product[]
  skuMappings  SkuMapping[]
  pricingRules PricingRule[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("suppliers")
}

model Category {
  id          String  @id @default(cuid())
  code        String  @unique // e.g., CONV, LVL, BRG
  name        String // e.g., "Conveyor Components"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  subCategories SubCategory[]
  products      Product[]
  pricingRules  PricingRule[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("categories")
}

model SubCategory {
  id          String  @id @default(cuid())
  code        String // e.g., BASES, UCF
  name        String // e.g., "Bases", "UCF Bearings"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Parent category
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  // Relations
  products     Product[]
  pricingRules PricingRule[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([categoryId, code])
  @@index([categoryId])
  @@map("sub_categories")
}

model Product {
  id            String        @id @default(cuid())
  supplierSku   String        @map("supplier_sku")
  nusafSku      String        @unique @map("nusaf_sku")
  description   String
  unitOfMeasure UnitOfMeasure @default(EA) @map("unit_of_measure")
  isActive      Boolean       @default(true) @map("is_active")

  // Pricing
  costPrice      Decimal?  @db.Decimal(10, 4) @map("cost_price")
  listPrice      Decimal?  @db.Decimal(10, 2) @map("list_price")
  priceUpdatedAt DateTime? @map("price_updated_at")

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Categorization
  categoryId    String       @map("category_id")
  category      Category     @relation(fields: [categoryId], references: [id])
  subCategoryId String?      @map("sub_category_id")
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  // Relations
  crossReferences CompetitorCrossReference[]

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([nusafSku])
  @@map("products")
}

model CompetitorCrossReference {
  id              String  @id @default(cuid())
  competitorBrand String  @map("competitor_brand") // e.g., "Rexnord", "Intralox"
  competitorSku   String  @map("competitor_sku")
  notes           String? // Fit notes, compatibility details

  // Verification for SEO quality
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  // Link to Nusaf product
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([competitorBrand, competitorSku])
  @@index([productId])
  @@index([competitorSku])
  @@map("competitor_cross_references")
}

model SkuMapping {
  id          String  @id @default(cuid())
  supplierSku String  @map("supplier_sku")
  nusafSku    String  @map("nusaf_sku")
  isOverride  Boolean @default(false) @map("is_override") // true = manual override, false = auto-generated
  notes       String? // Reason for override

  // Supplier (primarily for Tecom)
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Optional category reassignment (e.g., Idler Wheels moved to Sprockets and Idlers)
  overrideCategoryId String? @map("override_category_id")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierSku])
  @@index([nusafSku])
  @@map("sku_mappings")
}

// ============================================
// IMPORT TRACKING ENTITIES
// ============================================

model ImportBatch {
  id            String       @id @default(cuid())
  fileName      String       @map("file_name")
  supplierCode  String       @map("supplier_code")
  status        ImportStatus @default(PENDING)
  totalRows     Int          @default(0) @map("total_rows")
  processedRows Int          @default(0) @map("processed_rows")
  successRows   Int          @default(0) @map("success_rows")
  errorRows     Int          @default(0) @map("error_rows")

  // Column mapping used for import (stored as JSON)
  columnMapping Json? @map("column_mapping")

  // File errors (not row-level errors)
  fileErrors Json? @map("file_errors")

  // Relations
  rows ImportRow[]

  // Audit
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by")
  completedAt DateTime? @map("completed_at")

  @@index([supplierCode])
  @@index([status])
  @@index([createdAt])
  @@map("import_batches")
}

model ImportRow {
  id              String          @id @default(cuid())
  rowNumber       Int             @map("row_number")
  supplierSku     String          @map("supplier_sku")
  nusafSku        String?         @map("nusaf_sku")
  description     String?
  price           Decimal?        @db.Decimal(10, 4)
  unitOfMeasure   String?         @map("unit_of_measure")
  categoryCode    String?         @map("category_code")
  subcategoryCode String?         @map("subcategory_code")
  status          ImportRowStatus @default(PENDING)

  // Validation results (stored as JSON arrays)
  errors   Json? // Array of { field: string, message: string }
  warnings Json? // Array of { field: string, message: string }

  // Link to created/updated product (set after successful import)
  productId String? @map("product_id")

  // Parent batch
  batchId String      @map("batch_id")
  batch   ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  @@index([batchId])
  @@index([status])
  @@map("import_rows")
}

enum ImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  IMPORTING
  COMPLETED
  FAILED
}

enum ImportRowStatus {
  PENDING
  SUCCESS
  ERROR
  SKIPPED
}

enum QuoteStatus {
  DRAFT
  CREATED
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  CONVERTED
}

enum RejectionReason {
  PRICE_TOO_HIGH
  LEAD_TIME
  WENT_ELSEWHERE
  PROJECT_CHANGED
  SPECS_MISMATCH
  OTHER
}

// ============================================
// PRICING ENTITIES
// ============================================

model GlobalSettings {
  id            String   @id @default("global")
  eurZarRate    Decimal  @db.Decimal(10, 4) @map("eur_zar_rate")
  rateUpdatedAt DateTime @map("rate_updated_at")
  rateUpdatedBy String?  @map("rate_updated_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("global_settings")
}

model PricingRule {
  id              String       @id @default(cuid())
  supplierId      String       @map("supplier_id")
  supplier        Supplier     @relation(fields: [supplierId], references: [id])
  categoryId      String       @map("category_id")
  category        Category     @relation(fields: [categoryId], references: [id])
  subCategoryId   String?      @map("sub_category_id")
  subCategory     SubCategory? @relation(fields: [subCategoryId], references: [id])

  // Pricing parameters
  isGross         Boolean  @default(false) @map("is_gross")
  discountPercent Decimal? @db.Decimal(5, 2) @map("discount_percent")
  freightPercent  Decimal  @db.Decimal(5, 2) @map("freight_percent")
  marginDivisor   Decimal  @db.Decimal(5, 4) @map("margin_divisor")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([supplierId, categoryId, subCategoryId])
  @@index([supplierId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@map("pricing_rules")
}

// ============================================
// QUOTE ENTITIES
// ============================================

model Quote {
  id           String       @id @default(cuid())
  quoteNumber  String       @unique @map("quote_number") // QUO-2025-00001
  companyId    String       @map("company_id")
  company      Company      @relation(fields: [companyId], references: [id])
  userId       String       @map("user_id") // User who created the quote
  status       QuoteStatus  @default(DRAFT)
  customerTier CustomerTier @map("customer_tier") // Snapshot at time of quote

  // Validity
  validUntil DateTime? @map("valid_until") // Set on finalization (30 days)

  // Totals (ZAR)
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  vatRate   Decimal @default(15) @db.Decimal(5, 2) @map("vat_rate")
  vatAmount Decimal @default(0) @db.Decimal(12, 2) @map("vat_amount")
  total     Decimal @default(0) @db.Decimal(12, 2)

  // Notes
  customerNotes String? @map("customer_notes")

  // Rejection feedback
  rejectionReason RejectionReason? @map("rejection_reason")
  rejectionNotes  String?          @map("rejection_notes")
  rejectedAt      DateTime?        @map("rejected_at")

  // Document
  pdfUrl String? @map("pdf_url")

  // Relations
  items QuoteItem[]

  // Timestamps
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  finalizedAt    DateTime? @map("finalized_at")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([quoteNumber])
  @@index([lastActivityAt])
  @@map("quotes")
}

model QuoteItem {
  id         String @id @default(cuid())
  quoteId    String @map("quote_id")
  quote      Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  lineNumber Int    @map("line_number")

  // Product reference and snapshot
  productId          String @map("product_id")
  productSku         String @map("product_sku")         // Snapshot of nusafSku
  productDescription String @map("product_description") // Snapshot of description

  // Quantity and pricing
  quantity  Int     // Whole units only
  unitPrice Decimal @db.Decimal(12, 2) @map("unit_price") // Tier price at time of add
  lineTotal Decimal @db.Decimal(12, 2) @map("line_total") // quantity * unitPrice

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([quoteId])
  @@index([productId])
  @@map("quote_items")
}

model QuoteRequest {
  id          String @id @default(cuid())
  sessionId   String @map("session_id") // Browser session ID for guest tracking
  email       String
  companyName String @map("company_name")
  phone       String?
  notes       String?

  // Cart data (stored as JSON before conversion to Quote)
  cartData Json @map("cart_data")

  // Status
  isConverted Boolean   @default(false) @map("is_converted")
  convertedAt DateTime? @map("converted_at")
  convertedTo String?   @map("converted_to") // Quote ID if converted

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([email])
  @@index([isConverted])
  @@map("quote_requests")
}

model QuoteCounter {
  id    String @id @default("quote_counter")
  year  Int
  count Int    @default(0)

  @@map("quote_counter")
}
