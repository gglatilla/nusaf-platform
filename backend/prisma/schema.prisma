// Prisma Schema for Nusaf Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(CUSTOMER)
  isActive  Boolean  @default(true) @map("is_active")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  sessions Session[]

  // Auth metadata
  lastLoginAt    DateTime? @map("last_login_at")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Session {
  id           String  @id @default(cuid())
  token        String  @unique
  refreshToken String? @unique @map("refresh_token")
  userId       String  @map("user_id")
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Expiry
  expiresAt        DateTime  @map("expires_at")
  refreshExpiresAt DateTime? @map("refresh_expires_at")

  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Audit
  createdAt  DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Company {
  id                 String       @id @default(cuid())
  name               String
  tradingName        String?      @map("trading_name")
  registrationNumber String?      @map("registration_number")
  vatNumber          String?      @map("vat_number")
  tier               CustomerTier @default(END_USER)
  isActive           Boolean      @default(true) @map("is_active")

  users     User[]
  addresses CompanyAddress[]
  contacts  CompanyContact[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("companies")
}

model CompanyAddress {
  id         String      @id @default(cuid())
  companyId  String      @map("company_id")
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  type       AddressType
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String      @map("postal_code")
  country    String      @default("South Africa")
  isDefault  Boolean     @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_addresses")
}

model CompanyContact {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_contacts")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  SALES
  CUSTOMER
}

enum CustomerTier {
  END_USER
  OEM_RESELLER
  DISTRIBUTOR
}

enum AddressType {
  BILLING
  SHIPPING
}

enum SupplierCurrency {
  EUR
  ZAR
}

enum SkuHandling {
  DIRECT
  TECOM_CONVERSION
  NUSAF_INTERNAL
}

enum UnitOfMeasure {
  EA
  M
  KG
  BOX
  SET
  PAIR
  ROLL
}

// ============================================
// PRODUCT CATALOG ENTITIES
// ============================================

model Supplier {
  id          String           @id @default(cuid())
  code        String           @unique // TECOM, CHIARAVALLI, REGINA, NUSAF
  name        String
  country     String           @default("Italy")
  currency    SupplierCurrency @default(EUR)
  skuHandling SkuHandling      @map("sku_handling")
  isLocal     Boolean          @default(false) @map("is_local")
  isActive    Boolean          @default(true) @map("is_active")

  // Relations
  products    Product[]
  skuMappings SkuMapping[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("suppliers")
}

model Category {
  id          String  @id @default(cuid())
  code        String  @unique // e.g., CONV, LVL, BRG
  name        String // e.g., "Conveyor Components"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  subCategories SubCategory[]
  products      Product[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@map("categories")
}

model SubCategory {
  id          String  @id @default(cuid())
  code        String // e.g., BASES, UCF
  name        String // e.g., "Bases", "UCF Bearings"
  description String?
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Parent category
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  // Relations
  products Product[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([categoryId, code])
  @@map("sub_categories")
}

model Product {
  id            String        @id @default(cuid())
  supplierSku   String        @map("supplier_sku")
  nusafSku      String        @unique @map("nusaf_sku")
  description   String
  unitOfMeasure UnitOfMeasure @default(EA) @map("unit_of_measure")
  isActive      Boolean       @default(true) @map("is_active")

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Categorization
  categoryId    String       @map("category_id")
  category      Category     @relation(fields: [categoryId], references: [id])
  subCategoryId String?      @map("sub_category_id")
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  // Relations
  crossReferences CompetitorCrossReference[]

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierId])
  @@index([categoryId])
  @@index([nusafSku])
  @@map("products")
}

model CompetitorCrossReference {
  id              String  @id @default(cuid())
  competitorBrand String  @map("competitor_brand") // e.g., "Rexnord", "Intralox"
  competitorSku   String  @map("competitor_sku")
  notes           String? // Fit notes, compatibility details

  // Verification for SEO quality
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  // Link to Nusaf product
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([competitorBrand, competitorSku])
  @@index([productId])
  @@index([competitorSku])
  @@map("competitor_cross_references")
}

model SkuMapping {
  id          String  @id @default(cuid())
  supplierSku String  @map("supplier_sku")
  nusafSku    String  @map("nusaf_sku")
  isOverride  Boolean @default(false) @map("is_override") // true = manual override, false = auto-generated
  notes       String? // Reason for override

  // Supplier (primarily for Tecom)
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Optional category reassignment (e.g., Idler Wheels moved to Sprockets and Idlers)
  overrideCategoryId String? @map("override_category_id")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@unique([supplierId, supplierSku])
  @@index([supplierSku])
  @@index([nusafSku])
  @@map("sku_mappings")
}
